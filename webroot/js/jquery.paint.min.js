/*!
 * jQuery.paint
 *
 * Copyright (c) 2012-2013 ほと(@hoto17296).
 * https://github.com/hoto17296/jQuery.paint
 */
(function(e){e.fn.paint=function(t){if(a[t]){return a[t].apply(this,Array.prototype.slice.call(arguments,1))}else if(typeof t==="object"||!t){return a.init.apply(this,arguments)}else{e.error("Method "+t+" does not exist on jQuery.paint")}};var t={shape:"hand",color:"000000",thickness:10};var n={prefix:"paint",width:640,height:480,menu:{save:"保存",undo:"やり直し",clear:"クリア"},shape:{hand:"〜 手書き",line:"＼ 直線",rect:"□ 四角",arc:"◯ 円"},slider:{orientation:"vertical",animate:"slow",range:"min",value:10,min:1,max:40,slide:function(r,i){t.thickness=i.value;e("#"+n.prefix+"-property-thickness-val").val(i.value)}},colorpicker:{},file:null,upload:function(e){}};var r=false;var i=null;var s=document.ontouchstart!==undefined;var o={elem:null,w:n.width,h:n.height,context:function(e){if(!this.elem[0].getContext){return null}return this.elem[0].getContext(e||"2d")}};var u={x:0,oldX:0,y:0,oldY:0,pos:function(e){var t=e.target.getBoundingClientRect();if(s)e=e.originalEvent.touches[0];this.x=e.clientX-t.left;this.y=e.clientY-t.top},savePos:function(e){this.pos(e);this.oldX=this.x;this.oldY=this.y}};var a={init:function(r){var i=this;n=e.extend(n,r);var s=n.prefix;e(i).append(e("<form/>").addClass(s+"-tool").append(e("<div/>").addClass(s+"-menu")).append(function(){var t=e("<div/>").addClass(s+"-menu");e.each(n.menu,function(n,r){t.append(e("<button/>").attr("type","button").addClass(s+"-menu-"+n).text(r).button().click(function(){a[n].apply()}))});return t}()).append(function(){var r=e("<div/>").addClass(s+"-shape");e.each(n.shape,function(n,i){r.append(e("<input/>").attr({type:"radio",value:n,name:s+"-shape-checkbox",id:s+"-shape-"+n}).change(function(){t.shape=e(this).val()})).append(e("<label/>").attr("for",s+"-shape-"+n).text(i))});return r.buttonset()}()).append(e("<div/>").addClass(s+"-property").append(e("<div/>").addClass(s+"-property-color").append(e("<label/>").text("色")).append(e("<div/>").css("background-color","#"+t.color).colorpicker(n.colorpicker).on("changeColor",function(e){t.color=e.color}))).append(e("<div/>").addClass(s+"-property-thickness").append(e("<label/>").attr("for",s+"-property-thickness-val").text("太さ")).append(e("<input/>").attr({type:"text",value:n.slider.value,id:s+"-property-thickness-val"}).addClass(s+"-property-thickness-val")).append(e("<div/>").addClass(s+"-property-thickness-slider").slider(n.slider)))).append(e("<div/>").addClass(s+"-canvas").append(e("<canvas/>").addClass(s+"-canvas-file").attr({width:n.width,height:n.height}).drawRect({fillStyle:"#fff",x:0,y:0,width:n.width,height:n.height,fromCenter:false}).text("このブラウザはCanvasに対応していません")).append(e("<canvas/>").addClass(s+"-canvas-draw").attr({width:n.width,height:n.height}).mousedown(a.mousedown).bind("touchstart",a.mousedown).mouseup(a.mouseup).bind("touchend",a.mouseup).mousemove(a.mousemove).bind("touchmove",a.touchmove).mouseout(a.mouseout).bind("touchcancel",a.mouseout))));o.elem=e("."+n.prefix+"-canvas-draw");if(n.file)a.load(n.file);return this},load:function(t){var r=new Image;r.src=t;r.onload=function(){o.w=r.width;o.h=r.height;e("."+n.prefix+"-canvas canvas").attr({width:r.width,height:r.height});e("."+n.prefix+"-canvas-file").drawImage({source:r.src,fromCenter:false})}},save:function(){e("."+n.prefix+"-canvas-file").draw(function(e){e.drawImage(o.elem[0],0,0)});var t=e("."+n.prefix+"-canvas-file").getCanvasImage("jpeg");n.upload(t)},undo:function(){if(i==null)return;var e=i;a.saveUndo();o.context().putImageData(e,0,0)},clear:function(){i=null;o.elem.clearCanvas()},mousedown:function(e){r=true;u.savePos(e);a.saveUndo()},mousemove:function(e){if(!r)return;u.pos(e);switch(t.shape){case"hand":o.elem.drawLine({strokeStyle:t.color,strokeWidth:t.thickness,strokeCap:"round",strokeJoin:"miter",x1:u.oldX,x2:u.x,y1:u.oldY,y2:u.y});u.savePos(e);break;case"line":o.context().putImageData(i,0,0);o.elem.drawLine({strokeStyle:t.color,strokeWidth:t.thickness,strokeCap:"round",strokeJoin:"miter",x1:u.oldX,x2:u.x,y1:u.oldY,y2:u.y});break;case"rect":o.context().putImageData(i,0,0);o.elem.drawRect({strokeStyle:t.color,strokeWidth:t.thickness,x:u.oldX,y:u.oldY,width:u.x-u.oldX,height:u.y-u.oldY,fromCenter:false});break;case"arc":o.context().putImageData(i,0,0);o.elem.drawEllipse({strokeStyle:t.color,strokeWidth:t.thickness,x:u.oldX,y:u.oldY,width:u.x-u.oldX,height:u.y-u.oldY,fromCenter:false});break}},mouseup:function(e){r=false},mouseout:function(e){r=false},touchmove:function(e){a.mousemove(e);event.preventDefault()},saveUndo:function(){i=o.context().getImageData(0,0,o.w,o.h)}}})(jQuery)
