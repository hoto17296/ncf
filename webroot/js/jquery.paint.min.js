/*!
 * jQuery.paint
 *
 * Copyright (c) 2012 ほと(@hoto17296).
 * http://blog.hotolab.net/
 */
(function(a){a.fn.paint=function(b){if(h[b]){return h[b].apply(this,Array.prototype.slice.call(arguments,1))}else if(typeof b==="object"||!b){return h.init.apply(this,arguments)}else{a.error("Method "+b+" does not exist on jQuery.paint")}};var b={shape:"hand",color:"000000",thickness:10};var c={prefix:"paint",width:640,height:480,menu:{save:"保存",undo:"やり直し",clear:"クリア"},shape:{hand:"〜 手書き",line:"＼ 直線",rect:"□ 四角",arc:"◯ 円"},slider:{orientation:"vertical",animate:"slow",range:"min",value:10,min:1,max:40,slide:function(d,e){b.thickness=e.value;a("#"+c.prefix+"-property-thickness-val").val(e.value)}},colorpicker:{},file:null,upload:function(a){}};var d=false;var e=null;var f={elem:null,w:c.width,h:c.height};var g={x:0,oldX:0,y:0,oldY:0,pos:function(a){var b=a.target.getBoundingClientRect();this.x=a.clientX-b.left;this.y=a.clientY-b.top},savePos:function(a){this.pos(a);this.oldX=this.x;this.oldY=this.y}};var h={init:function(d){var e=this;c=a.extend(c,d);console.log(c);var g=c.prefix;a(e).append(a("<form/>").addClass(g+"-tool").append(a("<div/>").addClass(g+"-menu")).append(function(){var b=a("<div/>").addClass(g+"-menu");a.each(c.menu,function(c,d){b.append(a("<button/>").attr("type","button").addClass(g+"-menu-"+c).text(d).button().click(function(){h[c].apply()}))});return b}()).append(function(){var d=a("<div/>").addClass(g+"-shape");a.each(c.shape,function(c,e){d.append(a("<input/>").attr({type:"radio",value:c,name:g+"-shape-checkbox",id:g+"-shape-"+c}).change(function(){b.shape=a(this).val()})).append(a("<label/>").attr("for",g+"-shape-"+c).text(e))});return d.buttonset()}()).append(a("<div/>").addClass(g+"-property").append(a("<div/>").addClass(g+"-property-color").append(a("<label/>").text("色")).append(a("<div/>").css("background-color","#"+b.color).colorpicker(c.colorpicker).on("changeColor",function(a){b.color=a.color}))).append(a("<div/>").addClass(g+"-property-thickness").append(a("<label/>").attr("for",g+"-property-thickness-val").text("太さ")).append(a("<input/>").attr({type:"text",value:c.slider.value,id:g+"-property-thickness-val"}).addClass(g+"-property-thickness-val")).append(a("<div/>").addClass(g+"-property-thickness-slider").slider(c.slider)))).append(a("<div/>").addClass(g+"-canvas").append(a("<canvas/>").addClass(g+"-canvas-file").attr({width:c.width,height:c.height}).drawRect({fillStyle:"#fff",x:0,y:0,width:c.width,height:c.height,fromCenter:false}).text("このブラウザはCanvasに対応していません")).append(a("<canvas/>").addClass(g+"-canvas-draw").attr({width:c.width,height:c.height}).mousedown(h.mousedown).mouseup(h.mouseup).mousemove(h.mousemove).mouseout(h.mouseout))));f.elem=a("."+c.prefix+"-canvas-draw");if(c.file)h.load(c.file);return this},load:function(b){var d=new Image;d.src=b;d.onload=function(){f.w=d.width;f.h=d.height;a("."+c.prefix+"-canvas canvas").attr({width:d.width,height:d.height});a("."+c.prefix+"-canvas-file").drawImage({source:d.src,fromCenter:false})}},save:function(){a("."+c.prefix+"-canvas-file").draw(function(a){a.drawImage(f.elem[0],0,0)});var b=a("."+c.prefix+"-canvas-file").getCanvasImage("jpeg");c.upload(b)},undo:function(){if(e==null)return;var a=e;h.saveUndo();f.elem.loadCanvas().putImageData(a,0,0)},clear:function(){e=null;f.elem.clearCanvas()},mousedown:function(a){d=true;g.savePos(a);h.saveUndo()},mousemove:function(c){if(!d)return;g.pos(c);switch(b.shape){case"hand":a(this).drawLine({strokeStyle:b.color,strokeWidth:b.thickness,strokeCap:"round",strokeJoin:"miter",x1:g.oldX,x2:g.x,y1:g.oldY,y2:g.y});g.savePos(c);break;case"line":a(this).loadCanvas().putImageData(e,0,0);a(this).drawLine({strokeStyle:b.color,strokeWidth:b.thickness,strokeCap:"round",strokeJoin:"miter",x1:g.oldX,x2:g.x,y1:g.oldY,y2:g.y});break;case"rect":a(this).loadCanvas().putImageData(e,0,0);a(this).drawRect({strokeStyle:b.color,strokeWidth:b.thickness,x:g.oldX,y:g.oldY,width:g.x-g.oldX,height:g.y-g.oldY,fromCenter:false});break;case"arc":a(this).loadCanvas().putImageData(e,0,0);a(this).drawEllipse({strokeStyle:b.color,strokeWidth:b.thickness,x:g.oldX,y:g.oldY,width:g.x-g.oldX,height:g.y-g.oldY,fromCenter:false});break}},mouseup:function(a){d=false},mouseout:function(a){d=false},saveUndo:function(){e=f.elem.loadCanvas().getImageData(0,0,f.w,f.h)}}})(jQuery)